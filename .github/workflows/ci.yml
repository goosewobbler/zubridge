name: CI

on:
  push:
    branches:
      - main
      - v[0-9]+
    tags:
      - v[0-9]+.[0-9]+.[0-9]+*
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TELEMETRY_DISABLED: 1

jobs:
  # Build on Linux first since it's the fastest and its artifacts are used by all other jobs
  build:
    name: Build [Linux]
    uses: ./.github/workflows/_ci-build.reusable.yml
    with:
      os: 'ubuntu-latest'

  # Run linting after build to use the build artifacts
  lint:
    name: Lint [Linux]
    needs: [build]
    uses: ./.github/workflows/_ci-lint.reusable.yml
    with:
      cache_key: ${{ needs.build.outputs.cache_key }}

  # Run unit tests on all supported operating systems
  unit-matrix:
    name: Unit [${{ matrix.os.name }}]
    needs: [build, lint]
    strategy:
      fail-fast: false
      matrix:
        os:
          - {value: 'ubuntu-latest', name: 'Linux'}
          - {value: 'windows-latest', name: 'Windows'}
          - {value: 'macos-latest', name: 'macOS'}
    uses: ./.github/workflows/_ci-unit.reusable.yml
    with:
      os: ${{ matrix.os.value }}
      os_name: ${{ matrix.os.name }}
      build_id: ${{ needs.build.outputs.build_id }}
      artifact_size: ${{ needs.build.outputs.artifact_size }}
      cache_key: ${{ needs.build.outputs.cache_key }}

  # Run E2E tests for each mode
  e2e-matrix:
    name: E2E [${{ matrix.os.name }}] - ${{ matrix.mode }}
    needs: [build]
    strategy:
      matrix:
        os:
          - {value: 'ubuntu-latest', name: 'Linux'}
          - {value: 'windows-latest', name: 'Windows'}
          - {value: 'macos-latest', name: 'macOS'}
        mode: ['basic', 'handlers', 'reducers', 'redux', 'custom']
      fail-fast: false
    uses: ./.github/workflows/_ci-e2e.reusable.yml
    with:
      os: ${{ matrix.os.value }}
      os_name: ${{ matrix.os.name }}
      mode: ${{ matrix.mode }}
      build_id: ${{ needs.build.outputs.build_id }}
      artifact_size: ${{ needs.build.outputs.artifact_size }}
      cache_key: ${{ needs.build.outputs.cache_key }}
